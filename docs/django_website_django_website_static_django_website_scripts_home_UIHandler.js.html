<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: django_website/django_website/static/django_website/scripts/home/UIHandler.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: django_website/django_website/static/django_website/scripts/home/UIHandler.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>ï»¿/**
* Responsible for keeping the state of the UI
* @module "UIHandler.js"
*/



/**
 * Responsible for keeping user selections.
 * @param {string} SelectedMapMiner - Selected map miner's id
 * @param {string} SelectedMapFeature - Selected map features's id
 * @param {string} SelectedImageProvider - Selected image providers' id
 * @param {ImageProvider[]} _imageProviders - The collection of Image Providers as reported by the backend
 * @param {MapMiner[]} _mapMinersAndFeatures - The collection of Map Miners and its respective features as reported by the backend
 */
class UIHandler {
    constructor() {
        this.imageProviderDiv = $(`#imageProviderDiv`);
        this.mapMinerDiv = $(`#mapMinerDiv`);
        this.mapFeatureDiv = $(`#mapFeatureDiv`);
        this.btnCollectImages = $(`#btnCollectImages`);
        this.btnImageProvider = $(`#btnImageProvider`);        
        this.btnMapMiner = $(`#btnMapMiner`);
        this.btnMapFeature = $(`#btnMapFeature`);

        this._SelectedMapMiner = null;
        this._SelectedMapFeature = null;
        this._SelectedImageProvider = null;

        this._imageProviders = [];
        this._mapMinersAndFeatures = [];

        this.populateImageProviderDiv();
        this.populateMapMinersAndFeaturesDivs();


        this.btnExecuteQuery = $(`#btnExecuteQuery`);
        this.btnClearSelections = $(`#btnClearSelections`);
        this.btnClearSelections.on("click", this.clearSelections.bind(this));
    }

    set SelectedMapMiner(mapMinerId) {
        this._SelectedMapMiner = mapMinerId;

        this.btnExecuteQuery.removeClass("hidden");
        this.btnClearSelections.removeClass("hidden");
        this.btnMapMiner.addClass("btn-success");
        this.btnMapMiner.removeClass("btn-secondary");

        let mapMiner = this._mapMinersAndFeatures[mapMinerId];

        this.btnMapMiner.html(mapMiner.name);

        if (!this.SelectedMapFeature)
        {
            this.filterFeaturesByMapMiner(mapMiner);
            if (mapMiner.features.length === 1)
            {
                this.changeMapFeature(mapMiner.features[0]);
            }
        }
    }

    set SelectedMapFeature(mapFeatureName) {
        this._SelectedMapFeature = mapFeatureName;

        this.btnClearSelections.removeClass("hidden");
        this.btnExecuteQuery.removeClass("hidden");

        this.btnMapFeature.addClass("btn-success");
        this.btnMapFeature.removeClass("btn-secondary");

        this.btnMapFeature.html(mapFeatureName);

        if (!this.SelectedMapMiner)
        {
            this.filterMinersByFeatureName(mapFeatureName);
        }
    }

    set SelectedImageProvider(imageProviderId) {
        this._SelectedImageProvider = imageProviderId;

        this.btnCollectImages.removeClass("hidden");
        this.btnImageProvider.addClass("btn-success");
        this.btnImageProvider.removeClass("btn-secondary");

        this.btnImageProvider.html(this._imageProviders[imageProviderId].name);


    }

    get SelectedMapMiner() { return this._SelectedMapMiner; }
    get SelectedMapFeature() { this._SelectedMapFeature; }
    get SelectedImageProvider() { this._SelectedImageProvider; }

    /**
     * Creates an anchor button (&lt;a href...>)
     * @param {string} label - The button title
     * @param {object} optValue - The parameter to be used for the click handler
     * @param {function} clickHandler - A function that receives "optValue" as parameter and is triggered when the button is clicked
     */
    create_dropDown_aButton(label, optValue, clickHandler) {
        let button = $(document.createElement('a'));
        button.addClass('dropdown-item');
        button.append(label);
        button.attr("href", "javascript:void(0);");
        button.click(null, clickHandler.bind(this, optValue));
        return button;
    }

    /**
     * Resets the state of the user selections over the Map section
     */
    clearSelections() {

        //Selection fields
        this._SelectedMapFeature = null;
        this._SelectedMapMiner = null;

        //Execution buttons
        this.btnClearSelections.addClass("hidden");
        this.btnExecuteQuery.addClass("hidden");

        //Selection buttons
        this.btnMapMiner.html("Map Miner");
        this.btnMapFeature.html("Feature");
        this.btnMapMiner.addClass("btn-secondary");
        this.btnMapFeature.addClass("btn-secondary");
        this.btnMapMiner.removeClass("btn-success");
        this.btnMapFeature.removeClass("btn-success");

        this.populateMapMinersAndFeaturesDivs();
    }


    /**
     * Function used to collect map features, from the server,
     * based on [UIHandler.SelectedMapMiner]{@link module:"UIHandler.js"~UIHandler.SelectedMapMiner}
     * and [UIHandler.SelectedMapFeature]{@link module:"UIHandler.js"~UIHandler.SelectedMapFeature}
     * @param {Event} event - Event object generated by clicking over the 'btnExecuteQuery' DOMElement button.
     */
    executeQuery()
    {
        let noSelectedRegions = true;
        let numCalls = 0;
        try
        {
            setLoadingText(btnExecuteQuery);

            let olGeoJson = new ol.format.GeoJSON({ featureProjection: 'EPSG:3857' });
        
            for (let regionIdx in usersection.regions) {
                let region = usersection.getRegionById(regionIdx);

                if (!region.active) continue;
                let layerId = selectedMapMiner + "_" + selectedMapFeature;
                let layer = region.getLayerById(layerId);
                if (layer) continue;
                layer = region.createLayer(layerId);


                numCalls = numCalls + 1;
                noSelectedRegions = false;

                if (_UIHandler.SelectedMapMiner === null) {
                    alert("Please, select a Map Miner to continue.");
                    unsetLoadingText(btnExecuteQuery);
                    return;
                }
                if (_UIHandler.SelectedMapFeature === null) {
                    alert("Please, select a Feature to continue.");
                    unsetLoadingText(btnExecuteQuery);
                    return;
                }

                let geoJsonFeatures = olGeoJson.writeFeaturesObject([globalVectorSource.getFeatureById(region.id)]);

                geoJsonFeatures.crs = {
                    "type": "name",
                    "properties": {
                        "name": "EPSG:4326"
                    }
                };
                getMapMinerFeatures(region, selectedMapMiner, selectedMapFeature, geoJsonFeatures)
                .then(function(data){
                    layer.featureCollection = data;
                    numCalls = numCalls - 1;
                    if (numCalls == 0)
                    {
                        unsetLoadingText(btnExecuteQuery);
                    }
                })
                .catch(function (err) {
                    defaultAjaxErrorHandler('executeQuery', "error", err);
                });
            }

            if (noSelectedRegions) {
                alert("No region selected. Please, select a region to make a request.")
            }
        }
        catch(err)
        {
            unsetLoadingText(btnExecuteQuery);
            defaultAjaxErrorHandler('executeQuery', null, err);
        }
    }

    //#region Image Provider
    
    /**
     * Get the image providers available from the server and
     * creates &lt;a> buttons at the "imageProviderDiv" DOMElement
     */
    populateImageProviderDiv() {
        if (this._imageProviders.length === 0)
        {
            this.getImageProviders()
            .then((imageProviders) => {
                this._imageProviders = imageProviders;
                this._fillImageProviderDiv();
            })
        .catch((error) => console.error(error));
        }
        else
        {
            this._fillImageProviderDiv();
        }
    }

    /**
     * Represents a Image Provider
     * @typedef {ImageProvider}
     * @property {string} name - The name of the image provider used for displaying
     */

    /**
     * Calls server's "getimageproviders" GET endpoint for collecting available
     * image providers
     * @returns {Promise} resolve with a ImageProvider[] object array (with ImageProviderIds as keys) and rejects with the errorThrown string.
     */
    getImageProviders() {
        return new Promise(function (resolve, reject) {
            $.ajax("/getimageproviders/",
                {
                    cache: false,
                    method: "GET",
                    success: function (data, textStatus, jqXHR) { resolve(data); },
                    error: function (jqXHR, textStatus, errorThrown) { reject(errorThrown); },
                    dataType: "json"
                });
        });
    }

    /**
     * Called when [_imageProviders]{@link module:UIHandler~_imageProviders} is loaded and
     * the Image Provider Div should be (re)loaded too.
     * @private
     */
    _fillImageProviderDiv()
    {
        this.imageProviderDiv.empty();
        for (const imageProviderIdx in this._imageProviders) {
            let imageProviderName = this._imageProviders[imageProviderIdx].name;
            let btnImageProvider = this.create_dropDown_aButton(imageProviderName, imageProviderIdx, this.changeImageProviderClick);
            this.imageProviderDiv.append(btnImageProvider);
        }
    }

    /**
     * Handler for changing image provider.
     * @param {string} imageProviderId - Id defined by backend's class ImageProvider's subclasses
     * @param {Event} - See [Event]{@link https://developer.mozilla.org/en-US/docs/Web/API/Event}
     */
    changeImageProviderClick(imageProviderId) {
        this.SelectedImageProvider = imageProviderId;
    }

    //#endregion Image Provider

    //#region Map Miner and Features

    /**
     * Get the map miners and its respective features from the server and
     * creates &lt;a> buttons at the "mapMinerDiv" and "mapFeatureDiv" DOMElements
     */
    populateMapMinersAndFeaturesDivs() {
        
        if (this._mapMinersAndFeatures.length === 0)
        {
            this.getMapMinersAndFeatures().then((mapMiners) => { 
                this._mapMinersAndFeatures = mapMiners;
                this._fillMapMinersAndFeaturesDiv();
            })
            .catch((error) => console.error(error));
        }
        else
        {
            this._fillMapMinersAndFeaturesDiv();
        }
    }

    /**
     * Represents a MapMiner and its respective features
     * @typedef {MapMiner}
     * @property {string} name - The name of the map miner used for displaying
     * @property {string[]} features - The array of the features' names available from this map miner
     */

    /**
     * Calls server's "getavailablemapminers" GET endpoint for collecting available
     * map miners and its respective features
     * @returns {Promise} resolve with a MapMiner[] object array (with mapMinerIds as keys) and rejects with the errorThrown string.
     */
    getMapMinersAndFeatures() {
        return new Promise(function (resolve, reject) {
            $.ajax("/getavailablemapminers/",
                {
                    cache: false,
                    method: "GET",
                    success: function (data, textStatus, jqXHR) { resolve(data); },
                    error: function (jqXHR, textStatus, errorThrown) { reject(errorThrown); },
                    dataType: "json"
                });
        });
    }

    /**
     * Called when [_mapMinersAndFeatures]{@link module:UIHandler~_mapMinersAndFeatures} is loaded and
     * the Map Miner and Features Divs should be (re)loaded too.
     * @private
     */
    _fillMapMinersAndFeaturesDiv()
    {
        let currentMapFeatures = [];
        this.mapMinerDiv.empty();
        this.mapFeatureDiv.empty();
        for (const mapMinerId in this._mapMinersAndFeatures) {
            const mapMiner = this._mapMinersAndFeatures[mapMinerId];
            const btnMapMiner = this.create_dropDown_aButton(mapMiner.name, mapMinerId, this.changeMapMiner);
            this.mapMinerDiv.append(btnMapMiner);
            for (const featureIdx in mapMiner.features) {
                let featureName = mapMiner.features[featureIdx];
                if (currentMapFeatures.indexOf(featureName) !== -1) continue;
                let mapFeature = this.create_dropDown_aButton(featureName, featureName, this.changeMapFeature);
                this.mapFeatureDiv.append(mapFeature);
            }
        }
    }

    /**
     * Used as a handler for click events on Map Miner buttons from
     * MapMinerDiv
     * @param {string} mapMinerId - The MapMiner's id as reported by the backend
     */
    changeMapMiner(mapMinerId) {
        this.SelectedMapMiner = mapMinerId;
    }

    /**
     * Used as a handler for click events on Map Miner Feature buttons from mapFeatureDiv
     * @param {string} mapFeatureName - The Feature's name as reported by the backend
     */
    changeMapFeature(mapFeatureName) {
        this.SelectedMapFeature = mapFeatureName;
    }

    /**
     * Given a feature name it removes all the map miners from mapMinerDiv that don't contains this feature's name
     * @param {string} FeatureName - The name of the feature as reported by the backend
     */
    filterMinersByFeatureName(FeatureName) {
        this.mapMinerDiv.empty();
        let currentMapMiners = [];
        for (const mapMinerIdx in this._mapMinersAndFeatures) {
            let mapMiner = this._mapMinersAndFeatures[mapMinerIdx];
            if (mapMiner.features.indexOf(FeatureName) != -1) {
                let btnMapMiner = this.create_dropDown_aButton(mapMiner.name, mapMinerIdx, this.changeMapMiner);
                this.mapMinerDiv.append(btnMapMiner);
                currentMapMiners.push(mapMinerIdx);
            }
        }
        if (currentMapMiners.length === 1)
        {
            this.changeMapMiner(currentMapMiners[0]);
        }
    }

    /**
     * Given a MapMiner object it clears the mapFeatureDiv and fills it again only with the features
     * contained in the given MapMiner
     * @param {MapMiner} mapMiner - The MapMiner object
     * @param {string} mapMiner.name - The MapMiner name used for displaying
     * @param {string[]} mapMiner.features - The features' names contained by this MapMiner
     */
    filterFeaturesByMapMiner(mapMiner) {
        this.mapFeatureDiv.empty();
        for (const featureIdx in mapMiner.features) {
            let featureName = mapMiner.features[featureIdx];
            let mapFeature = this.create_dropDown_aButton(featureName, featureName, this.changeMapFeature);
            this.mapFeatureDiv.append(mapFeature);
        }
    }

    //#endregion Map Miner and Features



}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-_home.js_.html">"home.js"</a></li><li><a href="module-_UIHandler.js_.html">"UIHandler.js"</a></li><li><a href="module-GeoImageManager.html">GeoImageManager</a></li><li><a href="module-node_routes_index.html">node/routes/index</a></li><li><a href="module-Observer.html">Observer</a></li><li><a href="module-OpenLayersHandler.html">OpenLayersHandler</a></li><li><a href="module-StreetViewPanoramaData.html">StreetViewPanoramaData</a></li><li><a href="module-UserSection.html">UserSection</a></li></ul><h3>Classes</h3><ul><li><a href="module-_UIHandler.js_-UIHandler.html">UIHandler</a></li><li><a href="module-GeoImageManager-GeoImageManager.html">GeoImageManager</a></li><li><a href="module-Observer-Subject.html">Subject</a></li><li><a href="module-OpenLayersHandler-OpenLayersHandler.html">OpenLayersHandler</a></li><li><a href="module-StreetViewPanoramaData-gsvSize.html">gsvSize</a></li><li><a href="module-StreetViewPanoramaData-LatLng.html">LatLng</a></li><li><a href="module-StreetViewPanoramaData-Link.html">Link</a></li><li><a href="module-StreetViewPanoramaData-StreetViewPanoramaData.html">StreetViewPanoramaData</a></li><li><a href="module-StreetViewPanoramaData-Tile.html">Tile</a></li><li><a href="module-StreetViewPanoramaData-Time.html">Time</a></li><li><a href="module-UserSection-FeatureRegions.html">FeatureRegions</a></li><li><a href="module-UserSection-Layer.html">Layer</a></li><li><a href="module-UserSection-Region.html">Region</a></li><li><a href="module-UserSection-UserSection.html">UserSection</a></li></ul><h3>Events</h3><ul><li><a href="module-GeoImageManager-GeoImageManager.html#.event:geoimagescollectionchanged">geoimagescollectionchanged</a></li><li><a href="module-GeoImageManager-GeoImageManager.html#.event:imagechanged">imagechanged</a></li><li><a href="module-GeoImageManager-GeoImageManager.html#.event:invalidcollection">invalidcollection</a></li><li><a href="module-UserSection-Layer.html#event:activechange">activechange</a></li><li><a href="module-UserSection-Layer.html#event:featurecollectionchange">featurecollectionchange</a></li><li><a href="module-UserSection-Region.html#event:activechange">activechange</a></li><li><a href="module-UserSection-Region.html#event:addlayer">addlayer</a></li><li><a href="module-UserSection-UserSection.html#.event:featuresmerged">featuresmerged</a></li><li><a href="module-UserSection-UserSection.html#.event:regionlistitemclick">regionlistitemclick</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu Jul 19 2018 10:03:16 GMT-0300 (Hora oficial do Brasil)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
